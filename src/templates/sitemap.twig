{% extends 'pragmatic-seo/_layout' %}
{% import "_includes/forms" as forms %}

{% set title = 'Sitemap'|t('pragmatic-seo') %}
{% set selectedTab = 'sitemap' %}

{% set crumbs = [
  { label: 'SEO', url: url('pragmatic-seo') },
  { label: 'Sitemap'|t('pragmatic-seo'), url: url('pragmatic-seo/sitemap') },
] %}

{% block sidebar %}
  <nav aria-label="{{ 'Sections'|t('pragmatic-seo') }}">
    <ul class="nav">
      <li>
        <a class="{{ not sectionId ? 'sel' : '' }}" href="{{ url('pragmatic-seo/sitemap', { site: selectedSite.handle }) }}">
          {{ 'All entries'|t('pragmatic-seo') }}
        </a>
      </li>
      {% if sections|length %}
        <li class="heading"><span>{{ 'Sections'|t('pragmatic-seo') }}</span></li>
        {% for section in sections %}
          <li>
            <a class="{{ section.id == sectionId ? 'sel' : '' }}" href="{{ url('pragmatic-seo/sitemap', { site: selectedSite.handle, section: section.id }) }}">
              {{ section.name }}
            </a>
          </li>
        {% endfor %}
      {% endif %}
    </ul>
  </nav>
{% endblock %}

{% block content %}
  {% if rows is empty %}
    <p>{{ 'No entries with an SEO field in their layout.'|t('pragmatic-seo') }}</p>
  {% else %}
    <form method="post" accept-charset="UTF-8">
      {{ csrfInput() }}
      {{ actionInput('pragmatic-seo/default/save-sitemap') }}
      <input type="hidden" name="site" value="{{ selectedSite.id }}">
      {{ redirectInput('pragmatic-seo/sitemap', { site: selectedSite.handle, section: sectionId, page: page }) }}

      <table class="data fullwidth" style="margin-top: 16px;">
        <thead>
          <tr>
            <th>{{ 'Entry'|t('pragmatic-seo') }}</th>
            <th>{{ 'Visible in sitemap'|t('pragmatic-seo') }}</th>
            <th>{{ 'Include images'|t('pragmatic-seo') }}</th>
            <th>{{ 'Action'|t('pragmatic-seo') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for rowIndex, row in rows %}
            <tr>
              <td>
                <input type="hidden" name="entries[{{ rowIndex }}][entryId]" value="{{ row.entry.id }}">
                <input type="hidden" name="entries[{{ rowIndex }}][fieldHandle]" value="{{ row.fieldHandle }}">
                <a href="#" class="js-entry-slideout" data-entry-id="{{ row.entry.id }}" data-site-id="{{ row.entry.siteId }}">{{ row.entry.title|default('Entry #' ~ row.entry.id) }}</a>
                <div class="light">{{ row.entry.section.name ?? row.entry.type.name ?? '' }}</div>
              </td>
              <td>
                {{ forms.lightswitch({
                  name: "entries[#{rowIndex}][sitemapEnabled]",
                  on: row.sitemapEnabled,
                  value: 1,
                }) }}
              </td>
              <td>
                {{ forms.lightswitch({
                  name: "entries[#{rowIndex}][sitemapIncludeImages]",
                  on: row.sitemapIncludeImages,
                  value: 1,
                }) }}
              </td>
              <td style="white-space: nowrap;">
                <button class="btn submit" type="submit" name="saveRow" value="{{ rowIndex }}">{{ 'Save row'|t('pragmatic-seo') }}</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </form>

    <div class="flex justify-between align-center" style="margin-top: 16px;">
      <div>{{ total }} {{ 'total'|t('pragmatic-seo') }}</div>
      <div class="flex" style="gap: 8px; align-items: center;">
        {% set prevPage = page > 1 ? page - 1 : 1 %}
        {% set nextPage = page < totalPages ? page + 1 : totalPages %}
        {% if page == 1 %}
          <span class="btn disabled">{{ 'Prev'|t('pragmatic-seo') }}</span>
        {% else %}
          <a class="btn" href="{{ url('pragmatic-seo/sitemap', { page: prevPage, section: sectionId, site: selectedSite.handle }) }}">{{ 'Prev'|t('pragmatic-seo') }}</a>
        {% endif %}
        <div>{{ 'Page'|t('pragmatic-seo') }} {{ page }} / {{ totalPages }}</div>
        {% if page == totalPages %}
          <span class="btn disabled">{{ 'Next'|t('pragmatic-seo') }}</span>
        {% else %}
          <a class="btn" href="{{ url('pragmatic-seo/sitemap', { page: nextPage, section: sectionId, site: selectedSite.handle }) }}">{{ 'Next'|t('pragmatic-seo') }}</a>
        {% endif %}
      </div>
    </div>
  {% endif %}

  {% js %}
    document.querySelectorAll('.js-entry-slideout').forEach(function(link) {
      link.addEventListener('click', function(ev) {
        ev.preventDefault();
        var entryId = parseInt(link.getAttribute('data-entry-id'), 10);
        var siteId = parseInt(link.getAttribute('data-site-id'), 10);
        if (!entryId || !window.Craft) return;
        Craft.createElementEditor('craft\\elements\\Entry', {
          elementId: entryId,
          siteId: siteId || undefined,
          slideout: true,
        });
      });
    });

    // AJAX per-row save
    (function() {
      var form = document.querySelector('form[action]');
      if (!form) return;

      function displayNotice(message, isError) {
        if (window.Craft && Craft.cp) {
          if (isError && typeof Craft.cp.displayError === 'function') { Craft.cp.displayError(message); return; }
          if (!isError && typeof Craft.cp.displayNotice === 'function') { Craft.cp.displayNotice(message); return; }
        }
      }

      form.addEventListener('submit', function(event) {
        var submitter = event.submitter;
        if (!submitter || submitter.name !== 'saveRow') return;
        event.preventDefault();

        var formData = new FormData(form);
        formData.set(submitter.name, submitter.value);
        submitter.setAttribute('disabled', 'disabled');

        fetch(form.getAttribute('action') || window.location.href, {
          method: 'POST',
          body: formData,
          credentials: 'same-origin',
          headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then(function(r) { if (!r.ok) throw new Error('Failed'); return r.json(); })
          .then(function(data) {
            if (!data || data.success !== true) throw new Error((data && data.message) || 'Failed');
            displayNotice(data.message || 'Sitemap guardado.', false);
          })
          .catch(function(err) { displayNotice(err?.message || 'Error al guardar.', true); })
          .finally(function() { submitter.removeAttribute('disabled'); });
      });
    })();
  {% endjs %}
{% endblock %}
