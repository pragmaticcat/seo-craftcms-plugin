{% extends 'pragmatic-seo/_layout' %}
{% import "_includes/forms" as forms %}

{% set title = 'Content'|t('pragmatic-seo') %}
{% set selectedTab = 'content' %}

{% set crumbs = [
  { label: 'SEO', url: url('pragmatic-seo') },
  { label: 'Content'|t('pragmatic-seo'), url: url('pragmatic-seo/content') },
] %}

{% block content %}
  {% css %}
    tr.entry-group-border > td { border-top: 2px solid #d1d5db; }
  {% endcss %}

  <div class="flex" style="margin-top: 12px; gap: 16px; align-items: flex-end; justify-content: space-between;">
    <form method="get" id="entries-filter" class="flex" style="gap: 12px; align-items: flex-end;">
      <input type="hidden" name="page" value="1">
      <div>
        <label for="q">{{ 'Search'|t('pragmatic-seo') }}</label>
        <input class="text" type="text" id="q" name="q" value="{{ search }}" placeholder="{{ 'Entry title'|t('pragmatic-seo') }}">
      </div>
      <div>
        <label for="section">{{ 'Section'|t('pragmatic-seo') }}</label>
        <div class="select">
          <select id="section" name="section">
            <option value="">{{ 'All'|t('pragmatic-seo') }}</option>
            {% for section in sections %}
              <option value="{{ section.id }}" {{ section.id == sectionId ? 'selected' : '' }}>{{ section.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <label for="site">{{ 'Language'|t('pragmatic-seo') }}</label>
        <div class="select">
          <select id="site" name="site">
            {% for site in sites %}
              <option value="{{ site.id }}" {{ site.id == selectedSiteId ? 'selected' : '' }}>{{ site.name }} ({{ site.language }})</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <label for="perPage">{{ 'Per page'|t('pragmatic-seo') }}</label>
        <div class="select">
          <select id="perPage" name="perPage">
            {% for option in [50, 100, 250] %}
              <option value="{{ option }}" {{ option == perPage ? 'selected' : '' }}>{{ option }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </form>
  </div>

  <div id="content-results">
    <form method="post" accept-charset="UTF-8">
      {{ csrfInput() }}
      {{ actionInput('pragmatic-seo/default/save-content') }}
      <input type="hidden" name="site" value="{{ selectedSiteId }}">
      {{ redirectInput('pragmatic-seo/content', { q: search, perPage: perPage, page: page, section: sectionId, site: selectedSiteId }) }}

      <table class="data fullwidth" style="margin-top: 16px;">
        <thead>
          <tr>
            <th>{{ 'Entry'|t('pragmatic-seo') }}</th>
            <th>{{ 'Title'|t('pragmatic-seo') }}</th>
            <th>{{ 'Description'|t('pragmatic-seo') }}</th>
            <th>{{ 'Image'|t('pragmatic-seo') }}</th>
            <th>{{ 'Image description'|t('pragmatic-seo') }}</th>
            <th>{{ 'Action'|t('pragmatic-seo') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
            {% set rowIndex = loop.index0 %}
            {% set entryId = row.entry.id %}
            {% set prevEntryId = loop.first ? null : rows[loop.index0 - 1].entry.id %}
            {% set isFirstOfGroup = entryId != prevEntryId %}
            <tr{{ isFirstOfGroup and not loop.first ? ' class="entry-group-border"' : '' }} data-entry-id="{{ entryId }}">
              {% if isFirstOfGroup %}
                <td rowspan="{{ entryRowCounts[entryId] }}" style="vertical-align: top;">
                  <a href="#" class="js-entry-slideout" data-entry-id="{{ entryId }}" data-site-id="{{ row.entry.siteId }}">{{ row.entry.title|default('Entry #' ~ entryId) }}</a>
                  <div class="light">{{ row.entry.section.name ?? row.entry.type.name ?? 'No section or type' }}</div>
                </td>
              {% endif %}
              <td>
                <input type="hidden" name="entries[{{ rowIndex }}][entryId]" value="{{ entryId }}">
                <input type="hidden" name="entries[{{ rowIndex }}][fieldHandle]" value="{{ row.fieldHandle }}">
                <input class="text fullwidth" name="entries[{{ rowIndex }}][values][title]" value="{{ row.value.title ?? '' }}">
              </td>
              <td>
                <textarea class="text fullwidth" name="entries[{{ rowIndex }}][values][description]" rows="2">{{ row.value.description ?? '' }}</textarea>
              </td>
              <td>
                {% set imageElement = row.value.imageId ? (imageElementsById[row.value.imageId] ?? null) : null %}
                {{ forms.elementSelect({
                  id: 'entry-seo-image-' ~ rowIndex,
                  name: "entries[#{rowIndex}][values][imageId]",
                  elementType: 'craft\\\\elements\\\\Asset',
                  elements: imageElement ? [imageElement] : [],
                  limit: 1,
                  criteria: { kind: 'image' },
                  sources: '*',
                }) }}
              </td>
              <td>
                <textarea class="text fullwidth" name="entries[{{ rowIndex }}][values][imageDescription]" rows="2">{{ row.value.imageDescription ?? '' }}</textarea>
              </td>
              <td style="white-space: nowrap;">
                <button class="btn submit" type="submit" name="saveRow" value="{{ rowIndex }}">{{ 'Save row'|t('pragmatic-seo') }}</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </form>

    <div class="flex justify-between align-center" style="margin-top: 16px;">
      <div>{{ total }} {{ 'total'|t('pragmatic-seo') }}</div>
      <div class="flex" style="gap: 8px; align-items: center;">
        {% set prevPage = page > 1 ? page - 1 : 1 %}
        {% set nextPage = page < totalPages ? page + 1 : totalPages %}
        {% if page == 1 %}
          <span class="btn disabled">{{ 'Prev'|t('pragmatic-seo') }}</span>
        {% else %}
          <a class="btn" href="{{ url('pragmatic-seo/content', { q: search, perPage: perPage, page: prevPage, section: sectionId, site: selectedSiteId }) }}">{{ 'Prev'|t('pragmatic-seo') }}</a>
        {% endif %}
        <div>{{ 'Page'|t('pragmatic-seo') }} {{ page }} / {{ totalPages }}</div>
        {% if page == totalPages %}
          <span class="btn disabled">{{ 'Next'|t('pragmatic-seo') }}</span>
        {% else %}
          <a class="btn" href="{{ url('pragmatic-seo/content', { q: search, perPage: perPage, page: nextPage, section: sectionId, site: selectedSiteId }) }}">{{ 'Next'|t('pragmatic-seo') }}</a>
        {% endif %}
      </div>
    </div>
  </div>

  {% js %}
    (function() {
      const filterForm = document.getElementById('entries-filter');
      const searchInput = document.getElementById('q');
      const sectionSelect = document.getElementById('section');
      const siteSelect = document.getElementById('site');
      const perPageSelect = document.getElementById('perPage');
      const resultsContainer = document.getElementById('content-results');

      if (filterForm) {
        const pageInput = filterForm.querySelector('input[name="page"]');
        let searchTimer = null;
        let pendingRequest = null;

        function bindEntrySlideouts(root) {
          (root || document).querySelectorAll('.js-entry-slideout').forEach(function(link) {
            link.addEventListener('click', function(ev) {
              ev.preventDefault();
              const entryId = parseInt(link.getAttribute('data-entry-id'), 10);
              const siteId = parseInt(link.getAttribute('data-site-id'), 10);
              if (!entryId || !window.Craft) return;
              Craft.createElementEditor('craft\\elements\\Entry', {
                elementId: entryId,
                siteId: siteId || undefined,
                slideout: true
              });
            });
          });
        }

        function targetPathname() {
          return new URL(filterForm.getAttribute('action') || window.location.pathname, window.location.origin).pathname;
        }

        function buildUrlFromForm() {
          const query = new URLSearchParams(new FormData(filterForm)).toString();
          const targetUrl = filterForm.getAttribute('action') || window.location.pathname;
          return query ? (targetUrl + '?' + query) : targetUrl;
        }

        function syncFormFromUrl(fullUrl) {
          const url = new URL(fullUrl, window.location.origin);
          const params = url.searchParams;
          if (searchInput) searchInput.value = params.get('q') || '';
          if (sectionSelect) sectionSelect.value = params.get('section') || '';
          if (siteSelect) siteSelect.value = params.get('site') || (siteSelect.value || '');
          if (perPageSelect) perPageSelect.value = params.get('perPage') || (perPageSelect.value || '50');
          if (pageInput) pageInput.value = params.get('page') || '1';
        }

        function submitViaAjax(fullUrl) {
          if (!resultsContainer) {
            filterForm.submit();
            return;
          }

          const urlToLoad = fullUrl || buildUrlFromForm();
          window.history.replaceState({}, '', urlToLoad);
          syncFormFromUrl(urlToLoad);

          if (pendingRequest && typeof pendingRequest.abort === 'function') {
            pendingRequest.abort();
          }
          pendingRequest = new AbortController();

          fetch(urlToLoad, {
            method: 'GET',
            credentials: 'same-origin',
            signal: pendingRequest.signal,
          })
            .then(function(response) {
              if (!response.ok) throw new Error('Failed to load filtered content.');
              return response.text();
            })
            .then(function(html) {
              const doc = new DOMParser().parseFromString(html, 'text/html');
              const nextResults = doc.getElementById('content-results');
              const nextSectionSelect = doc.getElementById('section');
              const selectedSection = sectionSelect ? sectionSelect.value : '';

              if (sectionSelect && nextSectionSelect) {
                sectionSelect.innerHTML = nextSectionSelect.innerHTML;
                if (selectedSection && sectionSelect.querySelector('option[value="' + CSS.escape(selectedSection) + '"]')) {
                  sectionSelect.value = selectedSection;
                } else {
                  sectionSelect.value = '';
                }
              }

              if (!nextResults) return;
              resultsContainer.innerHTML = nextResults.innerHTML;
              if (window.Craft && typeof Craft.initUiElements === 'function') {
                Craft.initUiElements(resultsContainer);
              }
              bindEntrySlideouts(resultsContainer);
            })
            .catch(function(error) {
              if (error && error.name === 'AbortError') return;
              filterForm.submit();
            });
        }

        function displayNotice(message, isError) {
          if (window.Craft && Craft.cp) {
            if (isError && typeof Craft.cp.displayError === 'function') {
              Craft.cp.displayError(message);
              return;
            }
            if (!isError && typeof Craft.cp.displayNotice === 'function') {
              Craft.cp.displayNotice(message);
              return;
            }
          }
        }

        function saveRowViaAjax(form, submitter) {
          const formData = new FormData(form);
          if (submitter?.name) {
            formData.set(submitter.name, submitter.value);
          }

          submitter?.setAttribute('disabled', 'disabled');
          fetch(form.getAttribute('action') || window.location.href, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
              'Accept': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
            },
          })
            .then(function(response) {
              if (!response.ok) throw new Error('Failed to save row.');
              return response.json();
            })
            .then(function(data) {
              if (!data || data.success !== true) {
                throw new Error((data && data.message) || 'Failed to save row.');
              }
              displayNotice(data.message || 'Contenido SEO guardado.', false);
            })
            .catch(function(error) {
              displayNotice(error?.message || 'Error al guardar la fila.', true);
            })
            .finally(function() {
              submitter?.removeAttribute('disabled');
            });
        }

        function resetPageAndSubmit() {
          if (pageInput) pageInput.value = '1';
          submitViaAjax();
        }

        if (searchInput) {
          searchInput.addEventListener('input', function() {
            if (searchTimer) clearTimeout(searchTimer);
            searchTimer = setTimeout(resetPageAndSubmit, 300);
          });
        }
        if (sectionSelect) {
          sectionSelect.addEventListener('change', resetPageAndSubmit);
        }
        if (perPageSelect) {
          perPageSelect.addEventListener('change', resetPageAndSubmit);
        }
        if (siteSelect) {
          siteSelect.addEventListener('change', function() {
            if (searchInput) searchInput.value = '';
            if (sectionSelect) sectionSelect.value = '';
            resetPageAndSubmit();
          });
        }
        resultsContainer?.addEventListener('click', function(event) {
          const link = event.target.closest('a[href]');
          if (!link || link.classList.contains('js-entry-slideout')) return;

          const nextUrl = new URL(link.getAttribute('href'), window.location.origin);
          if (nextUrl.pathname !== targetPathname()) return;

          event.preventDefault();
          submitViaAjax(nextUrl.toString());
        });
        resultsContainer?.addEventListener('submit', function(event) {
          const form = event.target;
          if (!(form instanceof HTMLFormElement)) return;

          const submitter = event.submitter;
          if (!submitter || submitter.name !== 'saveRow') return;

          event.preventDefault();
          saveRowViaAjax(form, submitter);
        });
        bindEntrySlideouts(document);
      }
    })();
  {% endjs %}
{% endblock %}
