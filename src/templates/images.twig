{% extends 'pragmatic-seo/_layout' %}
{% import "_includes/forms" as forms %}

{% set title = 'Imagenes' %}
{% set selectedTab = 'images' %}

{% block content %}
  <form id="images-filter-form" method="get" action="{{ url('pragmatic-seo/images') }}" accept-charset="UTF-8" style="margin-bottom: 16px;">
    <input type="hidden" name="page" value="1">
    <div class="flex" style="gap: 12px; align-items: flex-end;">
      {{ forms.lightswitchField({
        id: 'used-only',
        name: 'used',
        on: usedOnly,
        value: 1,
        label: 'Mostrar solo imagenes usadas',
      }) }}
      <div>
        <label for="perPage">Per page</label>
        <div class="select">
          <select id="perPage" name="perPage">
            {% for option in [50, 100, 250] %}
              <option value="{{ option }}" {{ option == perPage ? 'selected' : '' }}>{{ option }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </form>

  {% if rows is empty %}
    <p>No hay imagenes para mostrar con el filtro actual.</p>
  {% else %}
    <table class="data fullwidth">
      <thead>
        <tr>
          <th>Usado</th>
          <th>Asset</th>
          <th>Titulo</th>
          {% for column in textColumns %}
            <th>{{ column.name }}</th>
          {% endfor %}
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          {% set asset = row.asset %}
          {% set rowFormId = 'save-asset-' ~ asset.id %}
          <tr>
            <td>
              {% if row.isUsed %}
                <span class="status enabled"></span>Si
              {% else %}
                <span class="status"></span>No
              {% endif %}
            </td>
            <td>
              <a href="{{ asset.cpEditUrl }}" class="js-open-asset" data-asset-id="{{ asset.id }}" data-site-id="{{ asset.siteId }}">{{ asset.filename }}</a><br>
              <code>ID {{ asset.id }}</code>
            </td>
            <td>
              {{ forms.text({
                form: rowFormId,
                name: "assets[#{asset.id}][title]",
                value: asset.title,
              }) }}
            </td>
            {% for column in textColumns %}
              {% set value = row.fieldValues[column.handle] ?? null %}
              <td>
                {% if value is same as(null) %}
                  <span class="light">-</span>
                {% else %}
                  {{ forms.text({
                    form: rowFormId,
                    name: "assets[#{asset.id}][fields][#{column.handle}]",
                    value: value,
                  }) }}
                {% endif %}
              </td>
            {% endfor %}
            <td>
              <button type="submit" class="btn submit" form="{{ rowFormId }}" name="saveRowId" value="{{ asset.id }}">Guardar fila</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% for row in rows %}
      {% set asset = row.asset %}
      {% set rowFormId = 'save-asset-' ~ asset.id %}
      <form id="{{ rowFormId }}" method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('pragmatic-seo/default/save-images') }}
        {{ redirectInput(url('pragmatic-seo/images', {
          used: usedOnly ? 1 : 0,
          perPage: perPage,
          page: page
        })) }}
      </form>
    {% endfor %}

    <div class="flex justify-between align-center" style="margin-top: 16px;">
      <div>{{ total }} total</div>
      <div class="flex" style="gap: 8px; align-items: center;">
        {% set prevPage = page > 1 ? page - 1 : 1 %}
        {% set nextPage = page < totalPages ? page + 1 : totalPages %}
        <a class="btn {{ page == 1 ? 'disabled' : '' }}" href="{{ url('pragmatic-seo/images', { used: usedOnly ? 1 : 0, perPage: perPage, page: prevPage }) }}">Prev</a>
        <div>Page {{ page }} / {{ totalPages }}</div>
        <a class="btn {{ page == totalPages ? 'disabled' : '' }}" href="{{ url('pragmatic-seo/images', { used: usedOnly ? 1 : 0, perPage: perPage, page: nextPage }) }}">Next</a>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% js %}
  const imagesFilterForm = document.getElementById('images-filter-form');
  const usedOnlySwitch = imagesFilterForm?.querySelector('input[type="checkbox"][name="used"]');
  const perPageSelect = imagesFilterForm?.querySelector('select[name="perPage"]');
  const pageInput = imagesFilterForm?.querySelector('input[name="page"]');
  if (imagesFilterForm && usedOnlySwitch) {
    usedOnlySwitch.addEventListener('change', () => {
      if (pageInput) pageInput.value = '1';
      imagesFilterForm.submit();
    });
  }
  if (imagesFilterForm && perPageSelect) {
    perPageSelect.addEventListener('change', () => {
      if (pageInput) pageInput.value = '1';
      imagesFilterForm.submit();
    });
  }

  document.querySelectorAll('.js-open-asset').forEach((link) => {
    link.addEventListener('click', (event) => {
      if (typeof Craft === 'undefined' || typeof Craft.createElementEditor !== 'function') {
        return;
      }

      event.preventDefault();
      const assetId = parseInt(link.dataset.assetId || '0', 10);
      const siteId = parseInt(link.dataset.siteId || '0', 10);
      if (!assetId || !siteId) {
        return;
      }

      Craft.createElementEditor('craft\\elements\\Asset', $(link), {
        elementId: assetId,
        siteId: siteId,
      });
    });
  });
{% endjs %}
