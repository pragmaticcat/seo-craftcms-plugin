{% extends 'pragmatic-seo/_layout' %}

{% set title = 'Audit'|t('pragmatic-seo') %}
{% set selectedTab = 'audit' %}

{% set crumbs = [
  { label: 'SEO', url: url('pragmatic-seo') },
  { label: 'Audit'|t('pragmatic-seo'), url: url('pragmatic-seo/audit') },
] %}

{% block actionButton %}
  <button id="run-audit-btn" class="btn danger" type="button">
    {{ 'Run audit'|t('pragmatic-seo') }}
  </button>
{% endblock %}

{% block sidebar %}
  <nav aria-label="{{ 'Sections'|t('pragmatic-seo') }}">
    <ul class="nav">
      <li class="{{ not sectionId ? 'sel' : '' }}">
        <a href="{{ url('pragmatic-seo/audit', { site: selectedSite.handle }) }}">
          {{ 'All entries'|t('pragmatic-seo') }}
        </a>
      </li>
      {% if sections|length %}
        <li class="heading"><span>{{ 'Sections'|t('pragmatic-seo') }}</span></li>
        {% for section in sections %}
          <li class="{{ section.id == sectionId ? 'sel' : '' }}">
            <a href="{{ url('pragmatic-seo/audit', { site: selectedSite.handle, section: section.id }) }}">
              {{ section.name }}
            </a>
          </li>
        {% endfor %}
      {% endif %}
    </ul>
  </nav>
  <div id="audit-status-filter" style="display:none;">
    <ul class="nav" style="margin-top: 16px;">
      <li class="heading"><span>{{ 'Status'|t('pragmatic-seo') }}</span></li>
      <li class="sel" data-filter="all">
        <a href="#" class="js-status-filter" data-filter="all">
          {{ 'All'|t('pragmatic-seo') }} <span id="count-all" class="light"></span>
        </a>
      </li>
      <li data-filter="error">
        <a href="#" class="js-status-filter" data-filter="error">
          {{ 'Errors'|t('pragmatic-seo') }} <span id="count-error" class="light"></span>
        </a>
      </li>
      <li data-filter="warn">
        <a href="#" class="js-status-filter" data-filter="warn">
          {{ 'Warnings'|t('pragmatic-seo') }} <span id="count-warn" class="light"></span>
        </a>
      </li>
      <li data-filter="ok">
        <a href="#" class="js-status-filter" data-filter="ok">
          OK <span id="count-ok" class="light"></span>
        </a>
      </li>
    </ul>
  </div>
{% endblock %}

{% block content %}
  {% css %}
    .seo-status {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .seo-status-ok { background: #dcfce7; color: #166534; }
    .seo-status-warn { background: #fef3c7; color: #92400e; }
    .seo-status-error { background: #fee2e2; color: #991b1b; }
    .seo-checks {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .seo-check {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      background: #eef2ff;
      color: #3730a3;
    }
    .seo-check.bad {
      background: #fef2f2;
      color: #b91c1c;
    }
    #audit-empty {
      padding: 24px 0;
      color: #6b7280;
    }
    #audit-progress {
      display: none;
      padding: 24px 0;
      color: #6b7280;
    }
  {% endcss %}

  <div id="audit-empty">
    <p>{{ 'Click "Run audit" to analyse entries in this section.'|t('pragmatic-seo') }}</p>
  </div>

  <div id="audit-progress">
    <p>{{ 'Running auditâ€¦'|t('pragmatic-seo') }}</p>
  </div>

  <div id="audit-results" style="display:none;">
    <p id="audit-truncated-notice" class="light" style="display:none;margin-bottom:8px;"></p>
    <table id="audit-table" class="data fullwidth">
      <thead>
        <tr>
          <th>{{ 'Entry'|t('pragmatic-seo') }}</th>
          <th>{{ 'Status'|t('pragmatic-seo') }}</th>
          <th>{{ 'Checks'|t('pragmatic-seo') }}</th>
        </tr>
      </thead>
      <tbody id="audit-tbody"></tbody>
    </table>
  </div>

  {% js %}
    (function() {
      var checkTooltips = {
        title: '{{ 'Missing final title. Define an SEO title or ensure the entry has a title.'|t('pragmatic-seo')|e('js') }}',
        description: '{{ 'Missing SEO description. Add one to improve search result snippets.'|t('pragmatic-seo')|e('js') }}',
        canonical: '{{ 'Could not resolve a canonical URL for this entry.'|t('pragmatic-seo')|e('js') }}',
        image: '{{ 'No SEO image. Recommended for improved social sharing.'|t('pragmatic-seo')|e('js') }}',
        robots: '{{ 'Check the robots directive for this page.'|t('pragmatic-seo')|e('js') }}',
        jsonLd: '{{ 'JSON-LD disabled in options for this language/site.'|t('pragmatic-seo')|e('js') }}',
        hreflang: '{{ 'Not enough localised variants detected to emit hreflang.'|t('pragmatic-seo')|e('js') }}',
      };

      var btn = document.getElementById('run-audit-btn');
      var emptyEl = document.getElementById('audit-empty');
      var progressEl = document.getElementById('audit-progress');
      var resultsEl = document.getElementById('audit-results');
      var tbody = document.getElementById('audit-tbody');
      var truncatedNotice = document.getElementById('audit-truncated-notice');
      var statusFilter = document.getElementById('audit-status-filter');
      var currentFilter = 'all';

      function setCount(id, n) {
        var el = document.getElementById(id);
        if (el) el.textContent = n > 0 ? '(' + n + ')' : '';
      }

      function applyFilter(filter) {
        currentFilter = filter;
        document.querySelectorAll('#audit-status-filter li[data-filter]').forEach(function(li) {
          li.classList.toggle('sel', li.getAttribute('data-filter') === filter);
        });
        if (!tbody) return;
        tbody.querySelectorAll('tr[data-status]').forEach(function(tr) {
          var show = filter === 'all' || tr.getAttribute('data-status') === filter;
          tr.style.display = show ? '' : 'none';
        });
      }

      function renderRows(rows) {
        if (!tbody) return;
        tbody.innerHTML = '';
        var counts = { ok: 0, warn: 0, error: 0 };
        rows.forEach(function(row) {
          if (counts[row.status] !== undefined) counts[row.status]++;

          var statusLabel = row.status === 'ok' ? 'OK' : (row.status === 'warn' ? '{{ 'Warning'|t('pragmatic-seo')|e('js') }}' : '{{ 'Error'|t('pragmatic-seo')|e('js') }}');
          var statusTitle = row.status === 'warn'
            ? '{{ 'There are recommended SEO warnings to improve visibility.'|t('pragmatic-seo')|e('js') }}'
            : (row.status === 'error' ? '{{ 'There are important SEO errors that should be fixed soon.'|t('pragmatic-seo')|e('js') }}' : '');

          var checksHtml = '';
          Object.keys(row.checks).forEach(function(key) {
            var passed = row.checks[key];
            var tip = passed ? '' : (checkTooltips[key] || '');
            var cls = passed ? 'seo-check' : 'seo-check bad';
            var titleAttr = (!passed && tip) ? ' title="' + tip.replace(/"/g, '&quot;') + '"' : '';
            checksHtml += '<span class="' + cls + '"' + titleAttr + '>' + key + ': ' + (passed ? 'ok' : 'fail') + '</span>';
          });

          var tr = document.createElement('tr');
          tr.setAttribute('data-status', row.status);
          tr.innerHTML =
            '<td>' +
              '<a href="#" class="js-entry-slideout" data-entry-id="' + row.entryId + '" data-site-id="' + row.entrySiteId + '">' + escapeHtml(row.entryTitle) + '</a>' +
              '<div class="light"><code>ID ' + row.entryId + '</code></div>' +
            '</td>' +
            '<td>' +
              '<span class="seo-status seo-status-' + row.status + '"' + (statusTitle ? ' title="' + statusTitle.replace(/"/g, '&quot;') + '"' : '') + '>' + statusLabel + '</span>' +
            '</td>' +
            '<td><div class="seo-checks">' + checksHtml + '</div></td>';
          tbody.appendChild(tr);
        });

        var total = counts.ok + counts.warn + counts.error;
        setCount('count-all', total);
        setCount('count-ok', counts.ok);
        setCount('count-warn', counts.warn);
        setCount('count-error', counts.error);

        applyFilter(currentFilter);
        bindSlideouts(tbody);
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }

      function bindSlideouts(root) {
        (root || document).querySelectorAll('.js-entry-slideout').forEach(function(link) {
          link.addEventListener('click', function(ev) {
            ev.preventDefault();
            var entryId = parseInt(link.getAttribute('data-entry-id') || '0', 10);
            var siteId = parseInt(link.getAttribute('data-site-id') || '0', 10);
            if (!entryId || !window.Craft || typeof Craft.createElementEditor !== 'function') return;
            Craft.createElementEditor('craft\\elements\\Entry', {
              elementId: entryId,
              siteId: siteId || undefined,
              slideout: true,
            });
          });
        });
      }

      function runAudit() {
        emptyEl.style.display = 'none';
        resultsEl.style.display = 'none';
        progressEl.style.display = '';
        btn.setAttribute('disabled', 'disabled');

        var params = new URLSearchParams(window.location.search);
        var url = Craft.getCpUrl('pragmatic-seo/audit/run') + '?' + params.toString();

        fetch(url, {
          method: 'GET',
          credentials: 'same-origin',
          headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then(function(response) {
            if (!response.ok) throw new Error('Request failed');
            return response.json();
          })
          .then(function(data) {
            progressEl.style.display = 'none';

            if (data.truncated) {
              truncatedNotice.textContent = '{{ 'Audited %scanned% of %total% entries to maintain performance.'|t('pragmatic-seo')|e('js') }}'
                .replace('%scanned%', data.scannedEntries)
                .replace('%total%', data.totalEntries);
              truncatedNotice.style.display = '';
            } else {
              truncatedNotice.style.display = 'none';
            }

            if (!data.rows || data.rows.length === 0) {
              emptyEl.querySelector('p').textContent = '{{ 'No entries with an SEO field found.'|t('pragmatic-seo')|e('js') }}';
              emptyEl.style.display = '';
              statusFilter.style.display = 'none';
            } else {
              renderRows(data.rows);
              resultsEl.style.display = '';
              statusFilter.style.display = '';
            }
          })
          .catch(function(err) {
            progressEl.style.display = 'none';
            emptyEl.querySelector('p').textContent = '{{ 'Failed to run audit. Please try again.'|t('pragmatic-seo')|e('js') }}';
            emptyEl.style.display = '';
          })
          .finally(function() {
            btn.removeAttribute('disabled');
          });
      }

      if (btn) {
        btn.addEventListener('click', runAudit);
      }

      document.querySelectorAll('.js-status-filter').forEach(function(link) {
        link.addEventListener('click', function(ev) {
          ev.preventDefault();
          applyFilter(link.getAttribute('data-filter'));
        });
      });
    })();
  {% endjs %}
{% endblock %}
