{% extends 'pragmatic-seo/_layout' %}

{% set title = 'Audit'|t('pragmatic-seo') %}
{% set selectedTab = 'audit' %}

{% set crumbs = [
  { label: 'SEO', url: url('pragmatic-seo') },
  { label: 'Audit'|t('pragmatic-seo'), url: url('pragmatic-seo/audit') },
] %}

{% block content %}
  {% css %}
    .seo-audit-summary {
      display: flex;
      gap: 10px;
      margin: 8px 0 14px;
    }
    .seo-audit-chip {
      background: #f3f4f6;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      color: #374151;
    }
    .seo-status {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .seo-status-ok { background: #dcfce7; color: #166534; }
    .seo-status-warn { background: #fef3c7; color: #92400e; }
    .seo-status-error { background: #fee2e2; color: #991b1b; }
    .seo-checks {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .seo-check {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      background: #eef2ff;
      color: #3730a3;
    }
    .seo-check.bad {
      background: #fef2f2;
      color: #b91c1c;
    }
  {% endcss %}

  <h2 style="margin-bottom: 4px;">Informe técnico SEO</h2>
  <p class="light" style="margin-top: 0;">Comprobaciones automáticas para mejorar cobertura e interpretación en Search Console.</p>

  {% set checkTooltips = {
    title: 'Falta título final. Define un título SEO o asegúrate de que la entry tenga título.',
    description: 'Falta descripción SEO. Añádela para mejorar snippets en resultados.',
    canonical: 'No se ha podido resolver URL canónica para esta entry.',
    image: 'No hay imagen SEO. Se recomienda para mejorar compartición social.',
    robots: 'Revisa la directiva robots para esta página.',
    jsonLd: 'JSON-LD desactivado en opciones para este idioma/sitio.',
    hreflang: 'No se han detectado suficientes variantes localizadas para emitir hreflang.',
  } %}

  <div class="seo-audit-summary">
    <span class="seo-audit-chip">Filas auditadas: {{ audit.summary.rows }}</span>
    <span class="seo-audit-chip">OK: {{ audit.summary.ok }}</span>
    <span class="seo-audit-chip">Avisos: {{ audit.summary.warn }}</span>
    <span class="seo-audit-chip">Errores: {{ audit.summary.error }}</span>
  </div>

  {% if audit.truncated %}
    <p class="light">Se han auditado {{ audit.scannedEntries }} entradas de {{ audit.totalEntries }} para mantener rendimiento.</p>
  {% endif %}

  {% if audit.rows is empty %}
    <p>No hay entradas con campo SEO para auditar.</p>
  {% else %}
      <table class="data fullwidth">
        <thead>
          <tr>
            <th>Entry</th>
            <th>Estado</th>
            <th>Checks</th>
          </tr>
        </thead>
        <tbody>
          {% for row in audit.rows %}
            <tr>
              <td>
                <a href="#" class="js-entry-slideout" data-entry-id="{{ row.entryId }}" data-site-id="{{ row.entrySiteId }}">{{ row.entryTitle }}</a>
                <div class="light"><code>ID {{ row.entryId }}</code></div>
              </td>
              <td>
                {% set statusTitle = row.status == 'warn'
                  ? 'Hay avisos SEO recomendados para mejorar visibilidad.'
                  : (row.status == 'error'
                    ? 'Hay errores SEO importantes que conviene corregir cuanto antes.'
                    : '') %}
                <span class="seo-status seo-status-{{ row.status }}" {{ statusTitle ? 'title="' ~ statusTitle|e ~ '"' : '' }}>
                  {{ row.status == 'ok' ? 'OK' : (row.status == 'warn' ? 'Aviso' : 'Error') }}
                </span>
              </td>
              <td>
                <div class="seo-checks">
                  {% for key, passed in row.checks %}
                    <span
                      class="seo-check {{ passed ? '' : 'bad' }}"
                      {{ (not passed and checkTooltips[key] is defined) ? 'title="' ~ checkTooltips[key]|e ~ '"' : '' }}
                    >
                      {{ key }}: {{ passed ? 'ok' : 'fail' }}
                    </span>
                  {% endfor %}
                </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% js %}
    (function() {
      document.querySelectorAll('.js-entry-slideout').forEach(function(link) {
        link.addEventListener('click', function(event) {
          event.preventDefault();
          const entryId = parseInt(link.getAttribute('data-entry-id') || '0', 10);
          const siteId = parseInt(link.getAttribute('data-site-id') || '0', 10);
          if (!entryId || !window.Craft || typeof Craft.createElementEditor !== 'function') {
            return;
          }

          Craft.createElementEditor('craft\\elements\\Entry', {
            elementId: entryId,
            siteId: siteId || undefined,
            slideout: true,
          });
        });
      });
    })();
  {% endjs %}
{% endblock %}
